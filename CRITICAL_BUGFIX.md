# 关键Bug修复：SDP约束逻辑错误

## 修复日期
2025-01-27 (第二次修复)

## ⚠️ 严重性
**🔴 CRITICAL** - 这是一个根本性的逻辑错误，导致SDP问题不可行(infeasible)

## 问题描述

### 症状
- SDP求解器返回状态：`infeasible`（不可行）
- 目标函数值：`-inf`
- 所有测试用例失败

### 根本原因
约束1（观测数据一致性）的逻辑完全错误。

#### 错误的理解 ❌
```python
# 错误：假设 p(a,b|x,y) = δ_{a,x} δ_{b,y}
target_prob = 1.0 if (a == x and b == y) else 0.0
```

这假设了：
- Alice准备态x，Bob准备态y
- Alice输出a=x，Bob输出b=y的概率为1（完美相关）
- 其他情况概率为0

**问题**：这与实际的物理场景不符！在MDI-QRNG中：
- `(a, b)` 是**离散化测量结果的索引**
- `(x, y)` 是**输入态的索引**
- 它们之间没有这种确定性关系！

#### 正确的理解 ✅
根据 `SDP_doubao.md` 第57行：

```
对每个σ（4个）、每个(a,b)（n^2个），添加等式：
Tr(sum_e M_{a,b,e} · ρ_σ) = P((a,b)|σ)
```

这意味着：
- `(a, b)` 对应离散化Bell测量的结果索引 `(k, l)`
- `σ` 对应输入态 `(s1, s2)` 即 `(x, y)`
- `P((a,b)|σ)` 是**实际计算出的条件概率**，存储在 `P_obs[e, x, y]` 中
- 其中 `e = a * n_bins + b`

## 修复方案

### 修复前（第310行）
```python
# 错误：假设完美相关
target_prob = 1.0 if (a == x and b == y) else 0.0
```

### 修复后（第309-314行）
```python
# 根据SDP_doubao.md的约束1：
# Tr(sum_e M_{a,b,e} · ρ_σ) = P((a,b)|σ)
# 这里(a,b)对应离散化测量结果，σ对应输入态(x,y)
# P_obs[e, x, y]中，e = a * n_bins + b
e_idx = a * (n_b) + b
target_prob = P_obs[e_idx, x, y]
```

## 技术细节

### 变量含义对照表

| 变量 | 物理含义 | 代码中的含义 | 取值范围 |
|------|----------|--------------|----------|
| `x, y` | 输入态索引 | `Rho_states[x][y]` | 0, 1 |
| `(s1, s2)` | 相位符号 | (+1,+1), (+1,-1), (-1,+1), (-1,-1) | ±1 |
| `(a, b)` | 离散测量结果索引 | `M_vars[a][b][e]` | 0 到 n_bins-1 |
| `(k, l)` | Bell测量离散化 | 对应 (a, b) | 0 到 n_bins-1 |
| `e` | Eve猜测结果 | `e = a * n_bins + b` | 0 到 n_e-1 |
| `P((a,b)\|σ)` | 条件概率 | `P_obs[e, x, y]` | [0, 1] |

### 约束的正确形式

对于每个输入态 `(x, y)` 和每个输出结果 `(a, b)`：

```
Tr(Σ_e M_{a,b,e} @ ρ_{x,y}) = P_obs[a*n_bins+b, x, y]
```

其中：
- 左边：对所有Eve的猜测`e`求和，计算POVM算子作用在输入态上的期望
- 右边：实际测量到结果`(a,b)`在输入态`(x,y)`下的概率

### 为什么之前会不可行？

旧约束要求：
```
Tr(Σ_e M_{0,0,e} @ ρ_{0,0}) = 1.0  // a=x=0, b=y=0
Tr(Σ_e M_{0,1,e} @ ρ_{0,0}) = 0.0  // a=0, x=0, b=1, y=0
...
```

但实际的物理概率 `P_obs` 可能是：
```
P_obs[0, 0, 0] = 0.001  // 非常小！
P_obs[1, 0, 0] = 0.499  // 接近0.5
...
```

当约束要求某个迹为1.0，但实际概率只有0.001时，约束系统**必然不可行**！

新约束正确地使用实际概率：
```
Tr(Σ_e M_{0,0,e} @ ρ_{0,0}) = 0.001  ✅
Tr(Σ_e M_{0,1,e} @ ρ_{0,0}) = 0.499  ✅
...
```

## 验证

修复后运行 `test_SDP.py`，预期结果：

```
✅ PhysicsEngine测试通过
✅ 小规模SDP求解通过  (status: optimal)
✅ 结果一致性通过
✅ 参数范围测试通过
```

## 影响范围

###修复前的问题
- ❌ 所有SDP求解都会失败（infeasible）
- ❌ 无法计算任何有意义的随机性
- ❌ 代码完全不可用

### 修复后
- ✅ SDP可以正确求解
- ✅ 得到有物理意义的结果
- ✅ H_min 在合理范围内

## 经验教训

1. **理解物理场景至关重要**
   - MDI-QRNG 不是"完美制备"场景
   - 测量结果与输入态之间是概率关系

2. **参考文档要仔细阅读**
   - `SDP_doubao.md` 清楚说明了约束形式
   - 不能想当然地假设约束

3. **数值测试很重要**
   - 如果概率计算出现很多0，应该警觉
   - 不可行(infeasible)通常意味着约束逻辑错误

## 相关文档

- [SDP_doubao.md](docs/SDP_doubao.md) - 正确的SDP建模方案
- [SDP.md](docs/SDP.md) - SDP问题描述
- [BUGFIX.md](BUGFIX.md) - 其他修复记录

---

**修复者**: Claude
**审核**: 待用户测试
**状态**: 🟢 已修复，待验证
