# MDI-QRNG 半定规划求解器使用说明

## 概述

这是一个基于连续变量Bell态测量的测量设备无关量子随机数生成器（MDI-QRNG）的半定规划（SDP）求解器。代码完全实现了文档中描述的物理模型和SDP优化问题。

## 主要特性

### ✅ 已完善的功能

1. **完整的物理模型实现**
   - 根据 LaTeX 文档实现了连续变量相干态的离散化概率分布计算
   - 正确实现了量子态的向量表示和密度矩阵构建
   - 完整的数值验证（概率归一化、密度矩阵性质检查）

2. **完整的SDP约束**
   - ✅ 约束1: 与观测数据一致性
   - ✅ 约束2: 半正定 (PSD) 约束
   - ✅ 约束3-4: 无信号约束
   - ✅ 约束5-6: 局部POVM归一化
   - ✅ 约束7: 概率归一化验证

3. **高性能并行计算**
   - 配置MOSEK多线程求解（默认24线程，适配i7-12800HX）
   - 支持自定义线程数
   - 优化的内点法求解器参数

4. **详细的进度跟踪**
   - 数据生成进度条
   - 约束构建进度条（PSD、数据一致性、无信号、归一化）
   - 求解过程实时反馈
   - 详细的时间统计（构建时间、求解时间、总时间）

5. **数值稳定性检查**
   - 概率归一化验证
   - 密度矩阵迹和特征值检查
   - 边际概率验证
   - 自动警告数值异常

6. **结果自动保存**
   - NumPy格式保存原始数据（.npz）
   - JSON格式保存元数据（易读）
   - 包含所有优化参数和求解统计
   - 自动创建results目录

7. **参数扫描功能**
   - 批量扫描不同μ值和离散化区间数
   - 自动保存所有结果
   - 生成汇总报告
   - 结果表格展示

## 安装依赖

```bash
pip install numpy scipy cvxpy tqdm mosek
```

**注意**: MOSEK需要许可证。学术用户可以免费获取。

## 使用方法

### 1. 单次运行（默认模式）

```bash
python src/SDP.py
```

这将运行默认参数：
- 平均光子数 μ = 0.5
- 离散化区间数 n = 3
- 积分边界 = ±10.0
- 使用24线程

### 2. 参数扫描模式

```bash
python src/SDP.py scan
```

这将对多组参数进行扫描：
- μ 范围: 0.1 到 5.0（10个点）
- n_bins: [2, 3, 4, 5]
- 总共40次优化

### 3. 自定义参数

修改 `SDP.py` 文件中的主程序部分：

```python
# 单次运行模式
mu_val = 1.0        # 修改平均光子数
n_bins_val = 4      # 修改离散化区间数
range_val = 15.0    # 修改积分边界
target_idx = (0, 0) # 修改目标输入对

result, results_dict = run_single_optimization(
    mu_val=mu_val,
    n_bins_val=n_bins_val,
    range_val=range_val,
    target_idx=target_idx,
    num_threads=16,  # 根据你的CPU调整线程数
    verbose=True,
    save_results=True
)
```

### 4. 程序化调用

```python
from SDP import PhysicsEngine, solve_mdi_sdp, run_single_optimization

# 方式1: 使用高级接口
result, results_dict = run_single_optimization(
    mu_val=0.5,
    n_bins_val=3,
    range_val=10.0,
    num_threads=24
)

# 方式2: 手动控制
engine = PhysicsEngine(mu=0.5, n_bins=3, range_val=10.0)
P_obs, Rho_states, p_e = engine.generate_data(verbose=True)
result, results_dict = solve_mdi_sdp(
    P_obs, Rho_states, p_e,
    target_indices=(0, 0),
    num_threads=24,
    verbose=True
)
```

## 输出说明

### 控制台输出示例

```
============================================================
MDI-QRNG 半定规划优化
============================================================

物理参数:
  平均光子数 μ = 0.5
  离散化区间数 n = 3
  积分边界 = ±10.0
  目标输入对 (x*, y*) = (0, 0)

============================================================
开始生成物理数据
============================================================

步骤 1/3: 计算条件概率 P(e|x,y)
  - 离散化区间数: 3
  - 总观测结果数 e: 9
  - 输入态数量: 4 (2x2)
  计算概率: 100%|████████████████| 36/36 [00:00<00:00]

  概率归一化检查:
    P(e|x=0,y=0) 求和 = 1.000000
    P(e|x=0,y=1) 求和 = 1.000000
    ...

步骤 2/3: 构建输入量子态密度矩阵
  ρ(x=0,y=0): Tr=1.000000, 最小特征值=0.000000
  ...

步骤 3/3: 计算边际概率 p(e)
  Σ p(e) = 1.000000
  p(e) 范围: [0.054321, 0.123456]

数据生成完成！
============================================================

============================================================
开始构建半定规划 (SDP) 问题
============================================================

问题规模:
  - Alice/Bob 子空间维度: 2 x 2
  - 联合空间维度: 4
  - Eve 测量结果数 (e): 9
  - 输入设置数 (x, y): 2 x 2
  - 目标输入对 (x*, y*): (0, 0)

步骤 1/6: 定义优化变量
  创建 M_{a,b,e} 变量: 2 x 2 x 9 = 36 个 4x4 厄米矩阵

步骤 2/6: 添加半正定 (PSD) 约束
  PSD约束: 100%|████████████████| 36/36 [00:00<00:00]
  已添加 36 个PSD约束

步骤 3/6: 添加观测数据一致性约束
  数据一致性: 100%|████████████████| 16/16 [00:00<00:00]
  已添加 16 个数据一致性约束

步骤 4/6: 构建无信号约束
  预计算求和项...
  无信号约束: 100%|████████████████| 36/36 [00:00<00:00]
  已添加 36 个无信号约束

步骤 5/6: 添加局部POVM归一化约束
  POVM归一化: 100%|████████████████| 18/18 [00:00<00:00]
  已添加 18 个POVM归一化约束

  验证: Σ p(e) = 1.00000000

步骤 6/6: 构建目标函数

SDP 问题构建完成！
  总变量数: 54
  总约束数: 106
  构建用时: 0.15 秒

============================================================
开始求解 SDP
============================================================

使用 MOSEK 求解器 (线程数: 24)
求解器参数: 相对间隙容差=1e-08
------------------------------------------------------------
[MOSEK输出...]
------------------------------------------------------------

============================================================
求解完成
============================================================
求解状态: optimal
目标函数值 G_MDI: 0.2876543210
求解用时: 2.34 秒
总用时: 2.49 秒

随机性分析:
  最小熵 H_min = -log2(G_MDI) = 1.798765 bits
  可提取随机比特数 ≈ 1.7988 bits per round

结果已保存:
  数据文件: results/sdp_result_mu0.5_n3_20250127_143022.npz
  元数据文件: results/sdp_result_mu0.5_n3_20250127_143022.json
```

### 保存的文件

#### NPZ文件（NumPy数据）
包含：
- `mu`, `n_bins`, `range_val`: 物理参数
- `optimal_value`: 最优目标函数值
- `P_obs`: 观测概率分布
- `p_e`: 边际概率
- 求解统计信息

#### JSON文件（元数据）
```json
{
  "mu": 0.5,
  "n_bins": 3,
  "range_val": 10.0,
  "target_indices": [0, 0],
  "optimal_value": 0.2876543210,
  "h_min": 1.798765,
  "status": "optimal",
  "solve_time_seconds": 2.34,
  "build_time_seconds": 0.15,
  "total_time_seconds": 2.49,
  "num_variables": 54,
  "num_constraints": 106,
  "num_threads": 24,
  "timestamp": "20250127_143022"
}
```

## 性能优化建议

### CPU线程配置

根据你的CPU核心数调整线程数：

| CPU型号 | 核心/线程 | 推荐设置 |
|---------|-----------|----------|
| i7-12800HX | 14核20线程 | `num_threads=20` |
| i9-13900K | 24核32线程 | `num_threads=32` |
| AMD Ryzen 9 7950X | 16核32线程 | `num_threads=32` |

### 内存使用

问题规模估算：
- n_bins=2: 约100MB内存
- n_bins=3: 约500MB内存
- n_bins=4: 约2GB内存
- n_bins=5: 约8GB内存

对于32GB内存，建议 n_bins ≤ 5。

### 求解时间估算

在i7-12800HX (24线程) 上的参考时间：

| n_bins | 变量数 | 约束数 | 求解时间 |
|--------|--------|--------|----------|
| 2 | 22 | 42 | ~1秒 |
| 3 | 54 | 106 | ~3秒 |
| 4 | 102 | 202 | ~15秒 |
| 5 | 170 | 330 | ~60秒 |

## 故障排除

### MOSEK许可证问题

如果遇到 "No license" 错误：

1. 学术用户：访问 https://www.mosek.com/products/academic-licenses/
2. 下载许可证文件并放置到合适位置
3. 或使用开源求解器（修改代码中的solver参数）

### 求解失败

如果求解状态不是 "optimal"：

1. 检查物理参数是否合理（μ > 0, n_bins ≥ 2）
2. 增大 `range_val`（推荐10-15）
3. 降低求解器容差（修改 `mosek_params`）
4. 检查概率归一化警告

### 内存不足

如果遇到内存错误：

1. 减小 `n_bins`
2. 关闭不必要的程序
3. 使用参数扫描时减少扫描点数

## 代码结构

```
src/SDP.py
├── PhysicsEngine 类
│   ├── __init__: 初始化物理参数和离散化边界
│   ├── get_conditional_prob: 计算P((k,l)|s1,s2)
│   ├── get_input_state_vector: 单模态向量表示
│   ├── get_joint_rho: 两模联合密度矩阵
│   └── generate_data: 生成所有输入数据
├── partial_trace: 偏迹计算工具函数
├── solve_mdi_sdp: SDP构建和求解
├── run_single_optimization: 单次优化封装
├── parameter_scan: 参数扫描功能
└── __main__: 命令行入口
```

## 理论背景

详见文档：
- `docs/SDP.md`: SDP问题描述
- `docs/SDP_solve.tex`: 物理模型推导

## 引用

如果使用本代码进行研究，请引用相关论文。

## 许可证

[添加许可证信息]

## 更新日志

### v2.0 (2025-01-27)
- ✅ 修复语法错误（np.concatenate）
- ✅ 添加详细的进度条和日志
- ✅ 配置MOSEK多线程并行（24线程）
- ✅ 添加数值稳定性检查
- ✅ 完善结果保存功能
- ✅ 添加参数扫描模式
- ✅ 添加随机性分析（H_min计算）
- ✅ 改进错误处理

### v1.0 (初始版本)
- 基本SDP实现
