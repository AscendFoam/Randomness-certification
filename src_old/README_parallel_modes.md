# 并行计算模式使用指南

## 概述

`reproduce_fig5_tomography.py` 支持三种并行计算模式，用户可根据任务特点选择最优方案。

## 三种并行模式对比

| 模式 | 适用场景 | 优点 | 缺点 | 内存消耗 | 速度 |
|------|---------|------|------|---------|------|
| **multi_task** | 多个计算点<br>(如m=5~25, 多个s_db) | 多任务并行<br>速度快 | 内存占用大 | 高 | 最快 |
| **single_sdp** | 单个或少量大规模SDP<br>(如m=24, o_A=12) | 内存占用小<br>适合大问题 | 需MOSEK<br>多任务慢 | 低 | 中等 |
| **none** | 极度内存受限<br>或调试 | 内存占用最小 | 速度最慢 | 最低 | 最慢 |

## 使用方法

在 `main()` 函数中修改 `parallel_mode` 参数：

```python
# 方式1: 多任务并行（默认推荐）
parallel_mode = 'multi_task'
max_workers = None  # 自动使用所有CPU核心

# 方式2: 单SDP并行（内存受限时）
parallel_mode = 'single_sdp'
max_workers = 8  # 指定线程数，或None表示使用所有核心

# 方式3: 完全串行（最节省内存）
parallel_mode = 'none'
max_workers = None  # 此模式下max_workers无效
```

## 详细说明

### 模式1: `multi_task` - 多任务并行

**工作原理：**
- 使用 `ProcessPoolExecutor` 创建多个进程
- 每个进程计算一个 (s_db, m_cutoff) 组合
- 每个SDP问题使用单线程求解

**推荐使用场景：**
```python
# 场景1: 扫描多个截断数
m_lb = 5
m_ub = 25  # 21个计算点
s_db_list = [-8, -6, -4]  # 3条曲线，共63个任务

# 场景2: 多个压缩度对比
m_lb = 15
m_ub = 20
s_db_list = [-14, -12, -10, -8, -6]  # 30个任务
```

**优点：**
- 多任务真正并行执行
- CPU利用率高
- 适合计算点数量多的场景

**注意事项：**
- m_cutoff > 24 时内存消耗急剧增加
- 并行任务数 = CPU核心数（或max_workers指定值）
- 推荐系统内存 ≥ 16GB（对于m≤20）

**性能示例：**
```
CPU: 16核
任务: 21个点 (m=5~25, s_db=-8)
multi_task模式: ~5分钟
single_sdp模式: ~18分钟
```

---

### 模式2: `single_sdp` - 单SDP并行

**工作原理：**
- 任务串行执行（一个接一个）
- 每个SDP问题使用MOSEK多线程优化
- 通过 `MSK_IPAR_NUM_THREADS` 参数控制线程数

**推荐使用场景：**
```python
# 场景1: 大规模单点计算
m_lb = 24
m_ub = 24  # 只计算一个点
o_A = 12   # 大分箱数
parallel_mode = 'single_sdp'
max_workers = 16  # 使用16线程加速单个SDP

# 场景2: 内存受限时的多点计算
m_lb = 20
m_ub = 25  # 6个大规模问题
s_db_list = [-14]
parallel_mode = 'single_sdp'  # 避免内存溢出
```

**优点：**
- 内存消耗低（同一时间只有一个任务）
- 可处理大规模SDP（m>24, o_A>10）
- 不会因并行导致内存溢出

**注意事项：**
- 需要安装MOSEK求解器（支持多线程）
- 多个任务时总时间较长（因为串行）
- SCS求解器不支持多线程，会退回单线程

**MOSEK安装：**
```bash
pip install mosek
# 学术免费许可证: https://www.mosek.com/products/academic-licenses/
```

---

### 模式3: `none` - 完全串行

**工作原理：**
- 任务串行执行
- 每个SDP使用单线程
- 无任何并行优化

**推荐使用场景：**
```python
# 场景1: 调试和验证
parallel_mode = 'none'  # 便于观察每步输出

# 场景2: 极度内存受限
# 例如：8GB RAM，需要计算m=22的点
```

**优点：**
- 内存消耗最小
- 输出清晰，便于调试
- 无并发相关的潜在问题

**缺点：**
- 速度最慢
- CPU利用率低

---

## 实际应用建议

### 1. 论文Fig5完整复现（m=5~25, 3条曲线）

```python
m_lb = 5
m_ub = 25
s_db_list = [-8, -6, -4]
o_A = 8
T_q = 4

# 推荐配置（16GB+ RAM）：
parallel_mode = 'multi_task'
max_workers = None  # 使用所有核心

# 内存受限配置（8GB RAM）：
parallel_mode = 'single_sdp'
max_workers = 4  # 减少线程数
```

### 2. 高精度单点计算（m=24, o_A=12）

```python
m_lb = 24
m_ub = 24
s_db_list = [-14]
o_A = 12
T_q = 4

# 推荐配置：
parallel_mode = 'single_sdp'
max_workers = None  # 使用所有核心加速SDP求解
```

### 3. 快速测试（少量点）

```python
m_lb = 10
m_ub = 12  # 只计算3个点
s_db_list = [-8]

# 推荐配置：
parallel_mode = 'multi_task'  # 快速并行
max_workers = 3  # 匹配任务数
```

---

## 常见问题

### Q1: 如何判断是否内存溢出？

**症状：**
- 程序卡住不动
- 系统变得非常慢
- 出现 `MemoryError` 或 `Killed`

**解决方案：**
```python
# 方法1: 切换到single_sdp模式
parallel_mode = 'single_sdp'

# 方法2: 减少并行工作进程数
parallel_mode = 'multi_task'
max_workers = 4  # 而不是16

# 方法3: 减小问题规模
m_ub = 20  # 而不是25
o_A = 8    # 而不是12
```

### Q2: MOSEK未安装，能否使用single_sdp模式？

**答案：** 可以，但会退回到单线程SCS求解器。

```python
# 代码会自动处理：
# 1. 尝试使用MOSEK（如果安装）
# 2. 失败则使用SCS
# 3. SCS不支持多线程，实际等同于'none'模式
```

建议安装MOSEK以充分利用`single_sdp`模式：
```bash
pip install mosek
```

### Q3: 如何选择max_workers？

**一般建议：**
```python
import multiprocessing

# 获取CPU核心数
cpu_count = multiprocessing.cpu_count()

# multi_task模式：
max_workers = cpu_count  # 或None（自动）

# single_sdp模式：
max_workers = cpu_count  # 使用所有核心

# 内存受限时：
max_workers = cpu_count // 2  # 减少并发数
```

**经验法则：**
- **multi_task**: `max_workers` = 任务数 与 CPU核心数 的较小值
- **single_sdp**: `max_workers` = CPU核心数（充分利用MOSEK多线程）

### Q4: 三种模式的性能差异有多大？

**示例测试（16核CPU, 32GB RAM）：**

| 任务配置 | multi_task | single_sdp | none |
|---------|-----------|-----------|------|
| m=5~15 (11点), s_db=-8 | 2分钟 | 6分钟 | 9分钟 |
| m=5~25 (21点), s_db=-8 | 5分钟 | 18分钟 | 35分钟 |
| m=24 (1点), o_A=12 | 4分钟 | 3分钟 | 4分钟 |

**结论：**
- 多任务时：`multi_task` 最快（3-4倍速度提升）
- 单任务时：`single_sdp` 和 `multi_task` 相近
- `none` 模式总是最慢

---

## 输出结果说明

运行结束后，结果会自动保存到 `output.txt`，包含：

```
================================================================================
运行时间: 2025-12-01 14:30:45
================================================================================

【配置参数】
--------------------------------------------------------------------------------
  压缩度列表 (s_db_list):         [-14] dB
  截断数下限 (m_lb):              24
  截断数上限 (m_ub):              24
  Alice测量结果数 (o_A):          11
  Alice q分量周期 (T_q):          4
  并行模式 (parallel_mode):       single_sdp
    └─ 单SDP并行，线程数:         16
  总计算点数:                     1
--------------------------------------------------------------------------------

【运行统计】
--------------------------------------------------------------------------------
  成功计算点数:                   1/1
  总运行时长:                     0小时 3分钟 25.67秒
  总运行时长(秒):                 205.67秒
  平均每任务用时:                 205.67秒
--------------------------------------------------------------------------------

【计算结果详情】
--------------------------------------------------------------------------------

压缩度 S = -14 dB:
m_cutoff    H_min (bits)      p_g (猜测概率)
--------------------------------------------------
24          1.8234567890      0.2823456789

================================================================================
```

并行模式信息会明确记录在配置参数中，方便对比不同模式的性能。
